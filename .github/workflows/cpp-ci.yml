name: C++ CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    paths:
      - 'cpp/**'
      - 'proto/**'
      - '.github/workflows/cpp-ci.yml'

defaults:
  run:
    working-directory: cpp

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
        cxx: [g++, clang++]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # Wait for any existing apt processes to finish
        while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
          echo "Waiting for other apt processes to finish..."
          sleep 10
        done
        sudo apt-get update
        sudo apt-get install -y cmake protobuf-compiler libprotobuf-dev libabsl-dev

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

    - name: Build
      run: |
        cd build
        cmake --build . --config ${{ matrix.build_type }} -j$(nproc)

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure -C ${{ matrix.build_type }}

    - name: Run examples
      run: |
        cd build
        ./examples/basic_example
        ./examples/cpu_emulator_example
        # Check that trace files were created
        test -f example.perfetto-trace
        test -f z80_emulation.perfetto-trace
    - name: Upload trace artifacts
      if: ${{ matrix.build_type == 'Release' && matrix.cxx == 'clang++' }}
      uses: actions/upload-artifact@v4
      with:
        name: cpp-interned-traces
        path: |
          cpp/build/example.perfetto-trace
          cpp/build/z80_emulation.perfetto-trace
        if-no-files-found: error
        retention-days: 7

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # Wait for any existing apt processes to finish
        while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
          echo "Waiting for other apt processes to finish..."
          sleep 10
        done
        sudo apt-get update
        sudo apt-get install -y clang-tidy cppcheck libprotobuf-dev protobuf-compiler cmake

    - name: Generate protobuf files
      working-directory: cpp
      run: |
        mkdir -p build
        cd build
        # Generate only the protobuf files, don't build everything
        cmake .. -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF
        # Only generate the proto files
        make perfetto_proto

    - name: Run clang-tidy
      working-directory: cpp
      run: |
        # Check if directory exists first
        if [ -d "include" ]; then
          # Find .hpp files and run clang-tidy on them
          hpp_files=$(find include -name '*.hpp')
          if [ -n "$hpp_files" ]; then
            echo "Running clang-tidy on C++ header files: $hpp_files"
            # Use for loop instead of xargs to ensure proper handling
            for file in $hpp_files; do
              clang-tidy "$file" -checks='-*,bugprone-*,cert-*,clang-analyzer-*,modernize-*,-modernize-use-trailing-return-type,performance-*,portability-*,readability-*,-readability-identifier-length,-readability-convert-member-functions-to-static,-readability-magic-numbers,-bugprone-easily-swappable-parameters' -- -std=c++17 -I/usr/include -Iinclude -Ibuild/proto
            done
          else
            echo "No .hpp files found to analyze"
            exit 0  # Don't fail if no files to analyze
          fi
        else
          echo "Directory include not found"
          exit 1
        fi

    - name: Run cppcheck
      working-directory: cpp
      run: |
        # Check if directory exists first
        if [ -d "include" ]; then
          echo "Running cppcheck on C++ header files..."
          # Run cppcheck on the actual header file
          cppcheck --enable=all --std=c++17 --suppress=missingIncludeSystem -I/usr/include -Iinclude -Ibuild/proto include/retrobus/retrobus_perfetto.hpp
        else
          echo "Directory include not found"
          exit 1
        fi

  documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Check README exists
      run: test -f README.md

    - name: Check header documentation
      run: |
        # Check that the main header has documentation
        grep -q "retrobus_perfetto.hpp - Header-only C++ library" include/retrobus/retrobus_perfetto.hpp
